#include <pebble.h>

#define ANIMATION_INTERVAL 30
#define STAR_NUM 15
#define Y_MIN 0
#define Y_MAX 167
#define WHITE   0
#define RED     1
#define LIBERTY 2
#define BLACK   3

#define FIXTURE_OFF    0
#define FIXTURE_BLUE   1
#define FIXTURE_ORANGE 2
#define FIXTURE_GREEN  3
#define FIXTURE_RED    4

static Window *s_main_window;

static Layer *s_space_layer;

static Layer *s_fixture_layer;
static GBitmap *s_fixture;
static BitmapLayer *s_fixture_bitmap_layer;

static Layer *s_switch_layer;
static GBitmap *s_switch_0;
static GBitmap *s_switch_1;
static GBitmap *s_switch_2;
static BitmapLayer *s_switch_bitmap_layer;

static TextLayer *s_time_layer;
static TextLayer *s_time_back_layer;
static TextLayer *s_date_layer;
static TextLayer *s_date_back_layer;
static GFont s_time_font;
static GFont s_date_font;

static Layer *s_mario_move_layer;
static Layer *s_luige_move_layer;

static BitmapLayer *s_mario_layer;
// 0 - 3: right
static GBitmap *s_mario_0;
static GBitmap *s_mario_1;
static GBitmap *s_mario_2;
static GBitmap *s_mario_3;
// 4 - 7: left
static GBitmap *s_mario_4;
static GBitmap *s_mario_5;
static GBitmap *s_mario_6;
static GBitmap *s_mario_7;

static BitmapLayer *s_luige_layer;
// 0 - 3: right
static GBitmap *s_luige_0;
static GBitmap *s_luige_1;
static GBitmap *s_luige_2;
static GBitmap *s_luige_3;
// 4 - 7: left
static GBitmap *s_luige_4;
static GBitmap *s_luige_5;
static GBitmap *s_luige_6;
static GBitmap *s_luige_7;

typedef struct {
    int point_x;         // range 0 - 143
    int point_y;         // range 0 - 167
    int current_counter; // range 0 - 3
    int current_color;   // range 0 - 3
} star;

typedef struct {
    int *color_list;
    int list_length;
} color_change;

typedef struct {
    int current_color;
    int frame;
    bool moveable;
    bool to_off;
} fixture_state;

fixture_state fixture;


typedef struct {
    int diff_x;
    int diff_y;
    int next_stripe;
} animation_frames;

typedef struct {
    int init_x;
    int init_y;
    int max_frame;
    animation_frames* animation;
} action;

typedef struct {
    bool moveable;
    int point_x;         
    int point_y;
    int stripe;  // range 0 - 7
    animation_frames* animation;
    int frame;
    int max_frame;
} character;

character mario;
character luige;

star background_star[STAR_NUM] = {
    {3,   54,  3, 2},
    {7,   36,  3, 1},
    {15,  133, 0, 1},
    {20,  68,  1, 2},
    {25,  47,  2, 1},
    {37,  147, 2, 3},
    {55,  78,  0, 1},
    {70,  68,  0, 1},
    {86,  41,  0, 1},
    {93,  141, 1, 2},
    {110, 97,  1, 2},
    {114, 67,  0, 2},
    {121, 54,  3, 0},
    {130, 120, 3, 3},
    {138, 15,  2, 0}
};

int to_off[] = {0};
int from_blue_to_red[] =   {2, 2, 3, 3, 4, 4, 1, 1, 2, 2, 3, 3, 4, 4};
int from_orange_to_blue[] = {1, 1, 2, 2, 3, 3, 4, 4, 1, 1};
int from_green_to_orange[] =  {1, 1, 2, 2, 3, 3, 4, 4, 1, 1, 2, 2};
int from_red_to_green[] =    {1, 2, 2, 2, 3, 3, 4, 4, 1, 1, 2, 2, 3, 3};

color_change color_changes[] = {
    {to_off, 1},
    {from_blue_to_red, 14},
    {from_orange_to_blue, 10},
    {from_green_to_orange, 12},
    {from_red_to_green, 14}
};

animation_frames walk_to_right[160] = {
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, // 60
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, // 120
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, 
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, 
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, 
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, 
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, 
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, 
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}                        // 160
};

animation_frames run_to_right[80] = {
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
};

animation_frames walk_to_left[160] = {
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4}, // 60
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4}, // 120
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}                          // 160
};

animation_frames run_to_left[80] = {
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4}, // 40
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4},
    {-2, 0, 5}, {-2, 0, 4}, {-2, 0, 6}, {-2, 0, 4}, // 80
};

animation_frames appear_and_jump[191] = {
    // go below switch: 78 frames
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, // 60
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0}, // 78
    // jump: 35 frames
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, -5, 3}, {0, -3, 3}, {0, -2, 3}, {0, -2, 3},
    {0, -1, 3}, {0, -1, 3}, {0,  0, 3}, {0, -1, 3},
    {0, 0, 3}, {0, 0, 3}, {0, 0, 3},
    {0, 1, 3}, {0, 2, 3}, {0, 2, 3}, {0, 2, 3},
    {0, 3, 3}, {0, 5, 3},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    // back to frame out: 78 frames
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4}, // 60
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4}, // 78
};

animation_frames jump_and_escape[140] = {
    // go below switch: 78 frames
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4}, // 60
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4}, // 78
    // jump: 23 frames
    {0, 0, 4}, {0, 0, 4}, {0, 0, 4},
    {0, 0, 4}, {0, 0, 4}, {0, 0, 4},
    {0, -5, 7}, {0, -3, 7}, {0, -2, 7}, {0, -2, 7},
    {0, -1, 7}, {0, -1, 7}, {0,  0, 7}, {0, -1, 7},
    {0, 0, 7}, {0, 0, 7}, {0, 0, 7},
    {0, 1, 7}, {0, 2, 7}, {0, 2, 7}, {0, 2, 7},
    {0, 3, 7}, {0, 5, 7},
    // escape to right 39 frames
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}
};

animation_frames loop_run_at_forward[256] = {
    // loop 1, 80 frames
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    // loop 2, 88 frames
    {-174, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    // loop 3, 88 frames
    {-174, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0}
};

animation_frames loop_run_at_back[270] = {
    // behind, 22 frames
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0},
    // loop 1, 80 frames
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    // loop 2, 88 frames
    {-174, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    // loop 3, 80 frames
    {-174, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
};

animation_frames walk_right_and_back[] = {
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},  // 54
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, 
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, 
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, 
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},  // 24
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4}, // 54

};

animation_frames luige_escape[330] = {
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4},
    {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4},
    {1, 0, 5}, {1, 0, 5}, {1, 0, 5}, {1, 0, 4}, {1, 0, 4}, {1, 0, 4},
    {1, 0, 6}, {1, 0, 6}, {1, 0, 6}, {1, 0, 4}, {1, 0, 4}, {1, 0, 4},
    {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4},
    {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4},
    {1, 0, 5}, {1, 0, 5}, {1, 0, 5}, {1, 0, 4}, {1, 0, 4}, {1, 0, 4},
    {1, 0, 6}, {1, 0, 6}, {1, 0, 6}, {1, 0, 4}, {1, 0, 4}, {1, 0, 4},
    {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4},
    {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4}, {0, 0, 4},
    {1, 0, 5}, {1, 0, 5}, {1, 0, 5}, {1, 0, 4}, {1, 0, 4}, {1, 0, 4},
    {1, 0, 6}, {1, 0, 6}, {1, 0, 6}, {1, 0, 4}, {1, 0, 4}, {1, 0, 4},  // walk 138
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},  // 154
    // loop 2, 88 frames
    {-174, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    // loop 3, 88 frames
    {-174, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0}
};

animation_frames mario_chase[346] = {
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},  // walk 138
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},  // 170
    // loop 2, 88 frames
    {-174, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    // loop 3, 88 frames
    {-174, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
    {2, 0, 1}, {2, 0, 0}, {2, 0, 2}, {2, 0, 0},
};

animation_frames luige_quick_turn[84] = {
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
};

animation_frames mario_stand[126] = {
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 1}, {1, 0, 1}, {1, 0, 1}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {1, 0, 2}, {1, 0, 2}, {1, 0, 2}, {1, 0, 0}, {1, 0, 0}, {1, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0}, {0, 0, 0},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 5}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
    {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 6}, {-1, 0, 4}, {-1, 0, 4}, {-1, 0, 4},
};


action actions[] = {
    {-15, 16, 160, walk_to_right},
    {-15, 16, 80,  run_to_right},
    {144, 16, 160, walk_to_left},
    {144, 16, 80,  run_to_left},
    {-15, 16, 191, appear_and_jump},
    {144, 16, 140, jump_and_escape},
    {-15, 16, 256, loop_run_at_forward},
    {-45, 16, 270, loop_run_at_back},
    {-15, 16, 132, walk_right_and_back},
    {144, 16, 330, luige_escape},
    {-15, 16, 346, mario_chase},
    {144, 16, 84,  luige_quick_turn},
    {-15, 16, 126,  mario_stand},
};

static void update_time() {
    time_t temp = time(NULL);
    struct tm *tick_time = localtime(&temp);

    static char time_buffer[6];  // "00:00"
    static char date_buffer[11]; // ""bbb,Mmm.dd";

    if( clock_is_24h_style() == true ) {
        strftime(time_buffer, 6, "%H:%M", tick_time);
    } else {
        strftime(time_buffer, 6, "%I:%M", tick_time);
    } 
    strftime(date_buffer, 12, "%a,%b.%d", tick_time);

    text_layer_set_text(s_time_layer, time_buffer);
    text_layer_set_text(s_time_back_layer, time_buffer);
    text_layer_set_text(s_date_layer, date_buffer);
    text_layer_set_text(s_date_back_layer, date_buffer);
}

static void set_character_animation(character* c, action a) {
    c->point_x = a.init_x;
    c->point_y = a.init_y;
    c->frame = 0;
    c->max_frame = a.max_frame;
    c->animation = a.animation;
    c->moveable = true;
}

static void update_background_layer(Layer *layer, GContext *ctx) {

    if (fixture.moveable == true) {
        gbitmap_destroy(s_fixture);
        bitmap_layer_destroy(s_fixture_bitmap_layer);
        GRect bounds = layer_get_bounds(layer);

        s_fixture_bitmap_layer = bitmap_layer_create(bounds);

        int color = color_changes[fixture.current_color].color_list[fixture.frame];
        if (fixture.to_off == true) {
            s_fixture = gbitmap_create_with_resource(RESOURCE_ID_IMAGE_BACKGROUND_OFF);
        } else if (color == 1) {
            s_fixture = gbitmap_create_with_resource(RESOURCE_ID_IMAGE_BACKGROUND_BLUE);
        } else if (color == 2) {
            s_fixture = gbitmap_create_with_resource(RESOURCE_ID_IMAGE_BACKGROUND_ORANGE);
        } else if (color == 3) {
            s_fixture = gbitmap_create_with_resource(RESOURCE_ID_IMAGE_BACKGROUND_GREEN);
        } else if (color == 4) {
            s_fixture = gbitmap_create_with_resource(RESOURCE_ID_IMAGE_BACKGROUND_RED);
        }
        bitmap_layer_set_bitmap(s_fixture_bitmap_layer, s_fixture);
        bitmap_layer_set_compositing_mode(s_fixture_bitmap_layer, GCompOpSet);
        layer_add_child(s_fixture_layer, bitmap_layer_get_layer(s_fixture_bitmap_layer));

        fixture.frame++;
        if (fixture.to_off == true) {
            fixture.moveable = false;
            fixture.frame = 0;
        } else if (fixture.frame == color_changes[fixture.current_color].list_length) {
            fixture.current_color = color;
            fixture.moveable = false;
            fixture.frame = 0;
        }
    }
}

int switch_show_flag = 4; // init with 4, range 0 - 5.
static void update_switch_animation(Layer *layer, GContext *ctx) {

    if (fixture.to_off == true) {
        bitmap_layer_set_bitmap(s_switch_bitmap_layer, s_switch_0);
    } else if (switch_show_flag < 3) {
        bitmap_layer_set_bitmap(s_switch_bitmap_layer, s_switch_1);
    } else {
        bitmap_layer_set_bitmap(s_switch_bitmap_layer, s_switch_2);
    }

    switch_show_flag++;
    if (switch_show_flag == 6) {
        switch_show_flag = 0;
    }
}


static void update_mario_animation(Layer *layer, GContext *ctx) {
    if (mario.moveable == true) {
        bitmap_layer_destroy(s_mario_layer);

        mario.point_x += mario.animation[mario.frame].diff_x;
        mario.point_y += mario.animation[mario.frame].diff_y;
        mario.stripe = mario.animation[mario.frame].next_stripe;

        if (mario.point_y == 1) {
            fixture.moveable = true;
            fixture.to_off = false;
        }

        s_mario_layer = bitmap_layer_create(GRect(mario.point_x, mario.point_y,
                                                  15, 21));

        if (mario.stripe == 0) { 
            bitmap_layer_set_bitmap(s_mario_layer, s_mario_0);
        } else if (mario.stripe == 1) {
            bitmap_layer_set_bitmap(s_mario_layer, s_mario_1);
        } else if (mario.stripe == 2) {
            bitmap_layer_set_bitmap(s_mario_layer, s_mario_2);
        } else if (mario.stripe == 3) {
            bitmap_layer_set_bitmap(s_mario_layer, s_mario_3);
        } else if (mario.stripe == 4) {
            bitmap_layer_set_bitmap(s_mario_layer, s_mario_4);
        } else if (mario.stripe == 5) {
            bitmap_layer_set_bitmap(s_mario_layer, s_mario_5);
        } else if (mario.stripe == 6) {
            bitmap_layer_set_bitmap(s_mario_layer, s_mario_6);
        } else if (mario.stripe == 7) {
            bitmap_layer_set_bitmap(s_mario_layer, s_mario_7);
        }

        bitmap_layer_set_compositing_mode(s_mario_layer, GCompOpSet);
        layer_add_child(s_mario_move_layer, bitmap_layer_get_layer(s_mario_layer));

        mario.frame++;
        if (mario.frame == mario.max_frame) {
            mario.moveable = false;
        }
    }
}

static void update_luige_animation(Layer *layer, GContext *ctx) {
    if (luige.moveable == true) {
        bitmap_layer_destroy(s_luige_layer);

        luige.point_x += luige.animation[luige.frame].diff_x;
        luige.point_y += luige.animation[luige.frame].diff_y;
        luige.stripe = luige.animation[luige.frame].next_stripe;

        if (luige.point_y == 1) {
            fixture.moveable = true;
            fixture.to_off = true;
        }

        s_luige_layer = bitmap_layer_create(GRect(luige.point_x, luige.point_y,
                                                  15, 21));

        if (luige.stripe == 0) { 
            bitmap_layer_set_bitmap(s_luige_layer, s_luige_0);
        } else if (luige.stripe == 1) {
            bitmap_layer_set_bitmap(s_luige_layer, s_luige_1);
        } else if (luige.stripe == 2) {
            bitmap_layer_set_bitmap(s_luige_layer, s_luige_2);
        } else if (luige.stripe == 3) {
            bitmap_layer_set_bitmap(s_luige_layer, s_luige_3);
        } else if (luige.stripe == 4) {
            bitmap_layer_set_bitmap(s_luige_layer, s_luige_4);
        } else if (luige.stripe == 5) {
            bitmap_layer_set_bitmap(s_luige_layer, s_luige_5);
        } else if (luige.stripe == 6) {
            bitmap_layer_set_bitmap(s_luige_layer, s_luige_6);
        } else if (luige.stripe == 7) {
            bitmap_layer_set_bitmap(s_luige_layer, s_luige_7);
        }

        bitmap_layer_set_compositing_mode(s_luige_layer, GCompOpSet);
        layer_add_child(s_luige_move_layer, bitmap_layer_get_layer(s_luige_layer));

        luige.frame++;
        if (luige.frame == luige.max_frame) {
            luige.moveable = false;
        }
    }

}

static void update_background_stars(Layer *layer, GContext *ctx) {
    for (int i=0; i<STAR_NUM; i++) {

        GPoint p = GPoint(background_star[i].point_x,
                          background_star[i].point_y);

        GColor c;
        if (background_star[i].current_color == WHITE) {
            c = GColorWhite;
        } else if (background_star[i].current_color == LIBERTY) {
            c = GColorLiberty;
        } else if (background_star[i].current_color == RED) {
            c = GColorRed;
        } else if (background_star[i].current_color == BLACK) {
            c = GColorBlack;
        }

        graphics_context_set_stroke_color(ctx, c);
        graphics_draw_pixel(ctx, p);

        background_star[i].point_y--;
        if (background_star[i].point_y < Y_MIN) {
            background_star[i].point_y = Y_MAX;
        }

        background_star[i].current_counter++;
        if (3 < background_star[i].current_counter) {
            background_star[i].current_counter = 0;
            background_star[i].current_color++;
            if (3 < background_star[i].current_color) {
                background_star[i].current_color = WHITE;
            }
        }
    }
}

static void main_window_load(Window *window) {

    Layer *window_layer = window_get_root_layer(window);
    GRect bounds = layer_get_bounds(window_layer);

    // 星を表示するレイヤー
    s_space_layer = layer_create(bounds);
    layer_add_child(window_layer, s_space_layer);
    layer_set_update_proc(s_space_layer, update_background_stars);

    // 背景のスイッチなど。一枚絵。
    s_fixture_layer = layer_create(bounds);
    layer_add_child(window_layer, s_fixture_layer);

    // シードがおかしいっぽいので手で設定する
    srand(time(NULL));

    // 初期の色をランダムで決定。1から4の値が取れればOK。
    fixture.current_color = (rand() % 4) + 1;
    fixture.frame = 0;
    fixture.to_off = false;
    fixture.moveable = false;

    if (fixture.current_color == 1) {
        s_fixture = gbitmap_create_with_resource(RESOURCE_ID_IMAGE_BACKGROUND_BLUE);
    } else if (fixture.current_color == 2) {
        s_fixture = gbitmap_create_with_resource(RESOURCE_ID_IMAGE_BACKGROUND_ORANGE);
    } else if (fixture.current_color == 3) {
        s_fixture = gbitmap_create_with_resource(RESOURCE_ID_IMAGE_BACKGROUND_GREEN);
    } else if (fixture.current_color == 4) {
        s_fixture = gbitmap_create_with_resource(RESOURCE_ID_IMAGE_BACKGROUND_RED);
    }
    s_fixture_bitmap_layer = bitmap_layer_create(layer_get_bounds(s_fixture_layer));
    bitmap_layer_set_bitmap(s_fixture_bitmap_layer, s_fixture);
    bitmap_layer_set_compositing_mode(s_fixture_bitmap_layer, GCompOpSet);

    layer_add_child(s_fixture_layer, bitmap_layer_get_layer(s_fixture_bitmap_layer));
    layer_set_update_proc(s_fixture_layer, update_background_layer);

    // スイッチを表示するレイヤー。頻繁にオンオフが発生するためダミーレイヤーを使う
    s_switch_layer = layer_create(GRect(68, 114, 8, 2));
    layer_add_child(window_layer, s_switch_layer);

    s_switch_0 = gbitmap_create_with_resource(RESOURCE_ID_SWITCH_0);
    s_switch_1 = gbitmap_create_with_resource(RESOURCE_ID_SWITCH_1);
    s_switch_2 = gbitmap_create_with_resource(RESOURCE_ID_SWITCH_2);

    s_switch_bitmap_layer = bitmap_layer_create(layer_get_bounds(s_switch_layer));
    bitmap_layer_set_bitmap(s_switch_bitmap_layer, s_switch_2);
    layer_add_child(s_switch_layer, bitmap_layer_get_layer(s_switch_bitmap_layer));

    layer_set_update_proc(s_switch_layer, update_switch_animation);


    // キャラクターを表示するレイヤー。マリオとルイージそれぞれを用意しなければならない
    s_mario_move_layer = layer_create(GRect(0, 114, 144, 37));
    layer_add_child(window_layer, s_mario_move_layer);

    s_luige_move_layer = layer_create(GRect(0, 114, 144, 37));
    layer_add_child(window_layer, s_luige_move_layer);

    // スプライトを全て宣言
    s_mario_0 = gbitmap_create_with_resource(RESOURCE_ID_MARIO_RIGHT_0);
    s_mario_1 = gbitmap_create_with_resource(RESOURCE_ID_MARIO_RIGHT_1);
    s_mario_2 = gbitmap_create_with_resource(RESOURCE_ID_MARIO_RIGHT_2);
    s_mario_3 = gbitmap_create_with_resource(RESOURCE_ID_MARIO_RIGHT_3);
    s_mario_4 = gbitmap_create_with_resource(RESOURCE_ID_MARIO_LEFT_0);
    s_mario_5 = gbitmap_create_with_resource(RESOURCE_ID_MARIO_LEFT_1);
    s_mario_6 = gbitmap_create_with_resource(RESOURCE_ID_MARIO_LEFT_2);
    s_mario_7 = gbitmap_create_with_resource(RESOURCE_ID_MARIO_LEFT_3);

    s_luige_0 = gbitmap_create_with_resource(RESOURCE_ID_LUIGE_RIGHT_0);
    s_luige_1 = gbitmap_create_with_resource(RESOURCE_ID_LUIGE_RIGHT_1);
    s_luige_2 = gbitmap_create_with_resource(RESOURCE_ID_LUIGE_RIGHT_2);
    s_luige_3 = gbitmap_create_with_resource(RESOURCE_ID_LUIGE_RIGHT_3);
    s_luige_4 = gbitmap_create_with_resource(RESOURCE_ID_LUIGE_LEFT_0);
    s_luige_5 = gbitmap_create_with_resource(RESOURCE_ID_LUIGE_LEFT_1);
    s_luige_6 = gbitmap_create_with_resource(RESOURCE_ID_LUIGE_LEFT_2);
    s_luige_7 = gbitmap_create_with_resource(RESOURCE_ID_LUIGE_LEFT_3);

    // キャラクターの座標を初期化
    mario.moveable = false;
    mario.point_x = 0;
    mario.point_y = 0; 
    mario.stripe = 0;
    mario.frame = 0;
    mario.max_frame = 0;

    luige.moveable = false;
    luige.point_x = 0;
    luige.point_y = 0; 
    luige.stripe = 0;
    luige.frame = 0;
    luige.max_frame = 0;

    // レイヤー更新の関数を登録
    layer_set_update_proc(s_mario_move_layer, update_mario_animation);
    layer_set_update_proc(s_luige_move_layer, update_luige_animation);

    // 時間表示部分
    s_time_font = fonts_load_custom_font(resource_get_handle(RESOURCE_ID_FONT_EMULOGIC_18));
    // お試しで文字に影をつける 重ねるため多分先に影を設定する
    // 影
    s_time_back_layer = text_layer_create(GRect(13, 42, 120, 20));
    text_layer_set_background_color(s_time_back_layer, GColorClear);
    text_layer_set_text_color(s_time_back_layer, GColorBlack);

    text_layer_set_font(s_time_back_layer, s_time_font);
    text_layer_set_text_alignment(s_time_back_layer, GTextAlignmentCenter);
    text_layer_set_text(s_time_back_layer, "00:00");
    layer_add_child(window_layer, text_layer_get_layer(s_time_back_layer));

    // オモテの部分
    s_time_layer = text_layer_create(GRect(10, 39, 120, 20));
    text_layer_set_background_color(s_time_layer, GColorClear);
    text_layer_set_text_color(s_time_layer, GColorWhite);

    text_layer_set_font(s_time_layer, s_time_font);
    text_layer_set_text_alignment(s_time_layer, GTextAlignmentCenter);
    text_layer_set_text(s_time_layer, "00:00");
    layer_add_child(window_layer, text_layer_get_layer(s_time_layer));


    // 日付表示部分
    s_date_font = fonts_load_custom_font(resource_get_handle(RESOURCE_ID_FONT_EMULOGIC_8));
    // 影
    s_date_back_layer = text_layer_create(GRect(13, 64, 120, 10));
    text_layer_set_background_color(s_date_back_layer, GColorClear);
    text_layer_set_text_color(s_date_back_layer, GColorBlack);

    text_layer_set_font(s_date_back_layer, s_date_font);
    text_layer_set_text_alignment(s_date_back_layer, GTextAlignmentCenter);
    text_layer_set_text(s_date_back_layer, "---.,---.--");
    layer_add_child(window_layer, text_layer_get_layer(s_date_back_layer));

    // オモテ
    s_date_layer = text_layer_create(GRect(11, 62, 120, 10));
    text_layer_set_background_color(s_date_layer, GColorClear);
    text_layer_set_text_color(s_date_layer, GColorWhite);

    text_layer_set_font(s_date_layer, s_date_font);
    text_layer_set_text_alignment(s_date_layer, GTextAlignmentCenter);
    text_layer_set_text(s_date_layer, "---,--(---)");
    layer_add_child(window_layer, text_layer_get_layer(s_date_layer));
    
    update_time();
}

int initial_flag = true;
static void tick_handler(struct tm *tick_time, TimeUnits units_changed) {
    update_time();

    // 起動直後の呼び出しはアニメーションを行わない
    if (initial_flag == true) {
        initial_flag = false;
        return;
    }

    // 1分ごとにイベント発生
    int event = rand() % 10;


    // 電源が切れていた場合は必ずマリオが電源を付けに行く
    if (fixture.to_off == true) {
        set_character_animation(&mario, actions[4]);
    } 
    // 0: ルイージが電源を切りに来る
    else if (event == 0) {
        set_character_animation(&luige, actions[5]);
    }
    // 1: マリオがスイッチを押しに来る
    else if (event == 1) {
        set_character_animation(&mario, actions[4]);
    }
    // 2: マリオが左から右に歩くだけ
    else if (event == 2) {
        set_character_animation(&mario, actions[0]);
    }
    // 3: マリオが左から右に走るだけ
    else if (event == 3) {
        set_character_animation(&mario, actions[1]);
    }
    // 4: マリオが様子を見に来る
    else if (event == 4) {
        set_character_animation(&mario, actions[8]);
    }
    // 5: ルイージが右から左に歩くだけ
    else if (event == 5) {
        set_character_animation(&luige, actions[2]);
    }
    // 6: ルイージが右から左に走り抜ける
    else if (event == 6) {
        set_character_animation(&luige, actions[3]);
    }
    // 7: 追いかけっこしている
    else if (event == 7) {
        set_character_animation(&luige, actions[6]);
        set_character_animation(&mario, actions[7]);
    }
    // 8: にじりよってから追いかけっこ
    else if (event == 8) {
        set_character_animation(&luige, actions[9]);
        set_character_animation(&mario, actions[10]);
    }
    // 9: すぐにバレて逃げる
    else if (event == 9) {
        set_character_animation(&luige, actions[11]);
        set_character_animation(&mario, actions[12]);
    }
}

static void timer_callback(void *context) {
    layer_mark_dirty(s_space_layer);
    app_timer_register(ANIMATION_INTERVAL, timer_callback, NULL);
}

static void main_window_unload(Window *window) {
    // destroy all resources.
    layer_destroy(s_space_layer);

    gbitmap_destroy(s_fixture);
    bitmap_layer_destroy(s_fixture_bitmap_layer);
    layer_destroy(s_fixture_layer);

    gbitmap_destroy(s_switch_0);
    gbitmap_destroy(s_switch_1);
    gbitmap_destroy(s_switch_2);
    bitmap_layer_destroy(s_switch_bitmap_layer);
    layer_destroy(s_switch_layer);

    fonts_unload_custom_font(s_time_font);
    fonts_unload_custom_font(s_date_font);
    text_layer_destroy(s_time_layer);
    text_layer_destroy(s_time_back_layer);
    text_layer_destroy(s_date_layer);
    text_layer_destroy(s_date_back_layer);

    gbitmap_destroy(s_mario_0);
    gbitmap_destroy(s_mario_1);
    gbitmap_destroy(s_mario_2);
    gbitmap_destroy(s_mario_3);
    gbitmap_destroy(s_mario_4);
    gbitmap_destroy(s_mario_5);
    gbitmap_destroy(s_mario_6);
    gbitmap_destroy(s_mario_7);

    gbitmap_destroy(s_luige_0);
    gbitmap_destroy(s_luige_1);
    gbitmap_destroy(s_luige_2);
    gbitmap_destroy(s_luige_3);
    gbitmap_destroy(s_luige_4);
    gbitmap_destroy(s_luige_5);
    gbitmap_destroy(s_luige_6);
    gbitmap_destroy(s_luige_7);

    if (mario.moveable == true) {
        bitmap_layer_destroy(s_mario_layer);
    }
    if (luige.moveable == true) {
        bitmap_layer_destroy(s_luige_layer);
    }

    layer_destroy(s_mario_move_layer);
    layer_destroy(s_luige_move_layer);
}

static void init() {
    s_main_window = window_create();
    window_set_background_color(s_main_window, GColorBlack);
    window_set_window_handlers(s_main_window, (WindowHandlers) {
        .load = main_window_load,
        .unload = main_window_unload
    });

    window_stack_push(s_main_window, true);
    app_timer_register(ANIMATION_INTERVAL, timer_callback, NULL);

    tick_timer_service_subscribe(MINUTE_UNIT, tick_handler);
}

static void deinit() {
    window_destroy(s_main_window);
}

int main(void) {
    init();
    app_event_loop();
    deinit();
}
